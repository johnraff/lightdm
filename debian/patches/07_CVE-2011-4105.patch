Description: ensure we don't chown links
Author: Marc Deslauriers <marc.deslauriers@canonical.com>

Index: lightdm-1.0.6/src/xsession.c
===================================================================
--- lightdm-1.0.6.orig/src/xsession.c	2011-11-25 07:22:24.509683804 +0100
+++ lightdm-1.0.6/src/xsession.c	2011-11-25 07:22:47.773863861 +0100
@@ -9,6 +9,7 @@
  * license.
  */
 
+#include <config.h>
 #include <errno.h>
 #include <string.h>
 #include <fcntl.h>
@@ -104,10 +105,26 @@
              * incorrectly written as root in a buggy version of LightDM */
             if (getuid () == 0)
             {
+                int fd = -1;
                 int result;
-                result = lchown (path, user_get_uid (session_get_user (session)), user_get_gid (session_get_user (session)));
+                struct stat st_buf;
+
+                fd = open (path, O_RDONLY|O_NOFOLLOW);
+                if (fd == -1)
+                    goto out;
+
+                if (fstat (fd, &st_buf) != 0)
+                    goto out;
+
+                if ((!S_ISREG (st_buf.st_mode)) || (st_buf.st_nlink > 1))
+                    goto out;
+
+                result = fchown (fd, user_get_uid (session_get_user (session)), user_get_gid (session_get_user (session)));
                 if (result < 0 && errno != ENOENT)
-                    g_warning ("Failed to correct ownership of %s: %s", path, strerror (errno));                
+                    g_warning ("Failed to correct ownership of %s: %s", path, strerror (errno));
+out:
+                if (fd > 0)
+                    close(fd);
             }
         }
 
Index: lightdm-1.0.6/configure.ac
===================================================================
--- lightdm-1.0.6.orig/configure.ac	2011-11-25 07:22:24.525683929 +0100
+++ lightdm-1.0.6/configure.ac	2011-11-25 07:22:27.489706870 +0100
@@ -1,6 +1,7 @@
 dnl Process this file with autoconf to produce a configure script.
 
 AC_INIT(lightdm, 1.0.6)
+AC_USE_SYSTEM_EXTENSIONS
 AC_CONFIG_MACRO_DIR(m4)
 AC_CONFIG_HEADER(config.h)
 AM_INIT_AUTOMAKE
